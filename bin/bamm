#!/usr/bin/python
###############################################################################
#                                                                             #
#    BamM.py                                                                  #
#                                                                             #
#    Get info from the BAM                                                    #
#                                                                             #
#    Copyright (C) Michael Imelfort                                           #
#                                                                             #
###############################################################################
#                                                                             #
#    This program is free software: you can redistribute it and/or modify     #
#    it under the terms of the GNU General Public License as published by     #
#    the Free Software Foundation, either version 3 of the License, or        #
#    (at your option) any later version.                                      #
#                                                                             #
#    This program is distributed in the hope that it will be useful,          #
#    but WITHOUT ANY WARRANTY; without even the implied warranty of           #
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #
#    GNU General Public License for more details.                             #
#                                                                             #
#    You should have received a copy of the GNU General Public License        #
#    along with this program. If not, see <http://www.gnu.org/licenses/>.     #
#                                                                             #
###############################################################################

__author__ = "Michael Imelfort"
__copyright__ = "Copyright 2014"
__credits__ = ["Michael Imelfort"]
__license__ = "GPLv3"
__version__ = "0.2.2"
__maintainer__ = "Michael Imelfort"
__email__ = "mike@mikeimelfort.com"
__status__ = "Beta"

###############################################################################
###############################################################################
###############################################################################
###############################################################################

# system imports
import argparse
import sys

# local imports
from bamm.bamParser import BamParser
from bamm.bamMaker import BamMaker
from bamm.bamExtractor import BamExtractor
from bamm.bammExceptions import *

###############################################################################
###############################################################################
###############################################################################
###############################################################################

def doWork( args ):
    """ Main wrapper"""
    if(args.subparser_name == 'make'):
        # making the class will take care of filenames and make sure that
        # all the parameters are set nicely
        try:
            BM = BamMaker(args.database,
                          args.alignment_algorithm,
                          args.index_algorithm,
                          args.out_filename,
                          args.reads_1,
                          readFile2=args.reads_2,
                          interleaved=args.interleaved,
                          singleEnded=args.single,
                          keptFiles=args.kept,
                          keepFiles=args.keep,
                          outputTam=args.output_tam,
                          numThreads=args.threads,
                          maxMemory=args.memory,
                          forceOverwriting=args.force
                          )
        except InvalidParameterSetException as e:
            printError(e)
            subparsers.choices['make'].print_help()
            sys.exit(1)

        # create indexes if required
        if(BM.keptFiles is False):
            BM.makeDatabase()

        # Now make the TAM/BAM file
        BM.makeBam()

        # clean up if we need to
        if BM.keepFiles is False and BM.keptFiles is False :
            BM.removeDatabase()

    elif(args.subparser_name == 'parse'):
        BP = BamParser(baseQuality=args.base_quality,
                       minLength=args.length,
                       mappingQuality=args.mapping_quality,
                       coverageMode=args.coverage_mode)

        # if called with no mode then just print types to stdout
        if (args.links == "") and (args.coverages == ""):
            doTypes = True
        else:
            doTypes = (args.types != "")

        ret = BP.parseBams(args.bamfiles,
                           doLinks=(args.links != ""),
                           doTypes=doTypes,
                           doCovs=(args.coverages != ""),
                           types=args.num_types,
                           threads=args.processes)
        if ret == 0:
            # print nice stuff out as required
            if doTypes:
                BP.printBamTypes(args.types)
            if args.links != "":
                BP.printLinks(args.links)
            if args.coverages != "":
                BP.printCoverages(args.coverages)

    elif(args.subparser_name == 'extract'):
        try:
            BE = BamExtractor(args.targets,
                              args.bamfiles,
                              prefix=args.prefix,
                              outFolder=args.out_folder,
                              shuffle=args.shuffle,
                              mixBams=args.mix_bams,
                              ignoreUnpaired=args.ignore_unpaired,
                              bigFile=args.no_gzip,
                              headersOnly=args.headers_only)
        except InvalidParameterSetException as e:
            printError(e)
            subparsers.choices['extract'].print_help()
            sys.exit(1)

        BE.extract()

    else:
        printError("Unknown mode '%s'" % args.subparser_name)
        parser.print_help()
        sys.exit(1)

###############################################################################
###############################################################################
###############################################################################
###############################################################################

def printHelp():
    print '''\

              ...::: BamM :::...

    Working with the BAM, not against it...

   -----------------------------------------
                version: %s
   -----------------------------------------

    bamm make     ->  Make a TAM/BAM file (sorted + indexed)
    bamm parse    ->  Get coverage profiles / linking reads / orientation types
    bamm extract  ->  Extract reads from BAM files

    USE: bamm OPTION -h to see detailed options
    ''' % __version__

if __name__ == '__main__':
    #-------------------------------------------------
    # intialise the options parser
    parser = argparse.ArgumentParser(add_help=False)
    subparsers = parser.add_subparsers(help="--", dest='subparser_name')

    #-------------------------------------------------
    # make a BAM file
    make_parser = subparsers.add_parser('make',
                                        formatter_class=argparse.ArgumentDefaultsHelpFormatter,
                                        help='make a TAM/BAM file (sorted + indexed)',
                                        description='make a TAM/BAM file (sorted + indexed)')
    make_parser.add_argument("-1", "--reads_1", default=None, help="The first data of a paired read file")
    make_parser.add_argument("-2", "--reads_2", default=None, help="The second data of a paired read file")
    make_parser.add_argument("-d", "--database", default=None, help="The scaffold, query, database...")

    make_parser.add_argument("-i", "--interleaved", action="store_true", default=False, help="The first query file contains interleaved paired sequences")
    make_parser.add_argument("-s", "--single", action="store_true", default=False, help="Use this for non-paired reads")

    make_parser.add_argument("--index_algorithm", default=None, help="The algorithm bwa uses for indexing 'bwtsw' or 'is' [None for auto]")
    make_parser.add_argument("--alignment_algorithm", default="mem", help="The algorithm bwa uses for alignment 'mem', 'bwasw' or 'aln'")

    make_parser.add_argument("-K", "--kept", action="store_true", default=False,
                           help="Assume the indices already exist, don't re-make them (and don't delete them) (e.g. previously this script was run with -k/--keep")
    make_parser.add_argument("-k", "--keep", action="store_true", default=False,
                           help="Keep all the database index files etc after (see also --kept)")
    make_parser.add_argument("-f", "--force", action="store_true", default=False,
                           help="Force overwriting of index files if they are present")

    make_parser.add_argument("-o", "--out_filename", default=None,
                           help="Output a sorted indexed bam file, of this name")
    make_parser.add_argument("--output_tam", action="store_true", default=False, help="Output TAM file instead of BAM file")

    make_parser.add_argument("-t", "--threads", type=int, default="1", help="The number of threads to use where possible")
    make_parser.add_argument("-m", "--memory", type=int, default=None, help="The amount of memory to use where possible (default 2GB*number of threads)")

    #-------------------------------------------------
    # determine linking reads
    parse_parser = subparsers.add_parser('parse',
                                        formatter_class=argparse.ArgumentDefaultsHelpFormatter,
                                        help='get bamfile type and/or coverage profiles and/or linking reads',
                                        description='get bamfile type and/or coverage profiles and/or linking reads')
    parse_parser.add_argument('bamfiles', nargs='+', help="bam files to parse")
    parse_parser.add_argument('--links', '-l', help="filename to write pairing links to", default="")
    parse_parser.add_argument('--coverages', '-c', help="filename to write coverage profiles to", default="")
    parse_parser.add_argument('--types', '-t', help="filename to write bamfile types to", default="")

    parse_parser.add_argument('--num_types', '-n', nargs='+', help="number of orientation types per BAM", type=int)
    parse_parser.add_argument('--coverage_mode' ,'-m', help="how to calculate coverage [vanilla, outlier] (requires --coverage)", default='vanilla')

    parse_parser.add_argument('--length', '-L', help="minimum Q length", type=int, default=50)
    parse_parser.add_argument('--base_quality', '-q', help="base quality threshold (Qscore)", type=int, default=20)
    parse_parser.add_argument('--mapping_quality', '-Q', help="mapping quality threshold", type=int, default=0)

    parse_parser.add_argument('--processes', '-p', help="number of threads to use", type=int, default=1)

    #-------------------------------------------------
    # read extractor
    extract_parser = subparsers.add_parser('extract',
                                        formatter_class=argparse.ArgumentDefaultsHelpFormatter,
                                        help='extract reads from bamfile(s)',
                                        description='Extract reads which hit the given references')
    extract_parser.add_argument('targets', help="file containing reference names (1 per line) or contigs file in fasta format")
    extract_parser.add_argument('bamfiles', nargs='+', help="bam files to parse")

    extract_parser.add_argument('-p', '--prefix', default="", help="prefix to apply to output files")
    extract_parser.add_argument('-o', '--out_folder', default=".", help="write to this folder (None for current dir)")

    extract_parser.add_argument('-s', '--shuffle', action="store_true", default=False, help="shuffle paired reads in ouput files")
    extract_parser.add_argument('-i', '--ignore_unpaired', action="store_true", default=False, help="ignore unpaired reads")
    extract_parser.add_argument('-m', '--mix_bams', action="store_true", default=False, help="use the same file for all reads")
    extract_parser.add_argument('-c', '--combine_reads', action="store_true", default=False, help="write paired and unpaired to the same files")

    extract_parser.add_argument('--no_gzip', action="store_true", default=False, help="do not gzip output files")
    extract_parser.add_argument('--headers_only', action="store_true", default=False, help="extract only (unique) headers")

    #-------------------------------------------------
    # get and check options
    args = None
    if(len(sys.argv) == 1):
        printHelp()
        sys.exit(0)
    elif(sys.argv[1] == '-v' or sys.argv[1] == '--version'):
        print "BamM: version %s %s %s" % (__version__, __copyright__, __author__)
        sys.exit(0)
    elif(sys.argv[1] == '-h' or sys.argv[1] == '--help'):
        printHelp()
        sys.exit(0)
    else:
        args = parser.parse_args()

    # profiling happens here. If you'd like to track the speed your code runs at
    # then set the following to True and voila!
    if(False):
        import cProfile
        cProfile.run('doWork(args)', 'profile')
        ##########################################
        ##########################################
        # Use this in python console!
        #import pstats
        #p = pstats.Stats('prof')
        #p.sort_stats('cumulative').print_stats(10)
        #p.sort_stats('time').print_stats(10)
        ##########################################
        ##########################################
    else:
        doWork(args)

###############################################################################
###############################################################################
###############################################################################
###############################################################################

